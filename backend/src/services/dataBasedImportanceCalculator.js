// Îç∞Ïù¥ÌÑ∞ Í∏∞Î∞ò Ï§ëÏöîÎèÑ Í≥ÑÏÇ∞ ÏÑúÎπÑÏä§
const WikipediaDataCollector = require('./wikipediaDataCollector');
const MetMuseumDataCollector = require('./metMuseumDataCollector');

class DataBasedImportanceCalculator {
  constructor() {
    this.wikipediaCollector = new WikipediaDataCollector();
    this.metMuseumCollector = new MetMuseumDataCollector();
  }

  async calculateImportanceScore(artistName) {
    try {
      console.log(`üîç ${artistName}Ïùò Ï§ëÏöîÎèÑ Î∂ÑÏÑù ÏãúÏûë...`);
      
      // 1Îã®Í≥Ñ: Îã§Ï§ë ÏÜåÏä§ÏóêÏÑú Îç∞Ïù¥ÌÑ∞ ÏàòÏßë
      const [wikipediaData, metMuseumData] = await Promise.all([
        this.wikipediaCollector.getArtistInfo(artistName),
        this.metMuseumCollector.getArtistInfo(artistName)
      ]);

      // 2Îã®Í≥Ñ: Îç∞Ïù¥ÌÑ∞ ÌÜµÌï©
      const consolidatedData = this.consolidateData(wikipediaData, metMuseumData, artistName);
      
      // 3Îã®Í≥Ñ: Ï§ëÏöîÎèÑ Ï†êÏàò Í≥ÑÏÇ∞
      const importanceScore = this.computeImportanceScore(consolidatedData);
      
      // 4Îã®Í≥Ñ: APT Ï∂îÏ†ïÏùÑ ÏúÑÌïú ÌäπÏßï Î∂ÑÏÑù
      const personalityIndicators = this.analyzePersonalityIndicators(consolidatedData);

      console.log(`‚úÖ ${artistName} Ï§ëÏöîÎèÑ Î∂ÑÏÑù ÏôÑÎ£å: ${importanceScore}Ï†ê`);
      
      return {
        artist_name: artistName,
        importance_score: importanceScore,
        data_sources: consolidatedData.sources,
        confidence_level: consolidatedData.confidence,
        biographical_data: {
          nationality: consolidatedData.nationality,
          birth_year: consolidatedData.birth_year,
          death_year: consolidatedData.death_year,
          art_movements: consolidatedData.art_movements,
          mediums: consolidatedData.mediums || []
        },
        personality_indicators: personalityIndicators,
        notable_works: consolidatedData.notable_works || [],
        analysis_metadata: {
          wikipedia_reliability: wikipediaData?.reliability || 0,
          museum_reliability: metMuseumData?.reliability || 0,
          total_sources: consolidatedData.sources.length,
          data_completeness: this.calculateDataCompleteness(consolidatedData)
        }
      };
    } catch (error) {
      console.error(`Ï§ëÏöîÎèÑ Í≥ÑÏÇ∞ Ïã§Ìå® (${artistName}):`, error.message);
      return null;
    }
  }

  consolidateData(wikipediaData, metMuseumData, artistName) {
    const consolidated = {
      name: artistName,
      sources: [],
      confidence: 'low',
      nationality: '',
      birth_year: null,
      death_year: null,
      art_movements: [],
      mediums: [],
      notable_works: [],
      bio: '',
      characteristics: [],
      total_reliability: 0
    };

    // Wikipedia Îç∞Ïù¥ÌÑ∞ ÌÜµÌï©
    if (wikipediaData) {
      consolidated.sources.push(...wikipediaData.sources);
      consolidated.nationality = wikipediaData.nationality || consolidated.nationality;
      consolidated.birth_year = wikipediaData.birth_year || consolidated.birth_year;
      consolidated.death_year = wikipediaData.death_year || consolidated.death_year;
      consolidated.art_movements.push(...(wikipediaData.art_movements || []));
      consolidated.bio = wikipediaData.bio || '';
      consolidated.characteristics.push(...(wikipediaData.characteristics || []));
      consolidated.total_reliability += wikipediaData.reliability || 0;
    }

    // Met Museum Îç∞Ïù¥ÌÑ∞ ÌÜµÌï©
    if (metMuseumData) {
      consolidated.sources.push(metMuseumData.source);
      
      // Ï†ïÎ≥¥ Î≥¥ÏôÑ (Wikipedia Ï†ïÎ≥¥Í∞Ä ÏóÜÎäî Í≤ΩÏö∞)
      if (!consolidated.nationality && metMuseumData.nationality) {
        consolidated.nationality = metMuseumData.nationality;
      }
      if (!consolidated.birth_year && metMuseumData.birth_year) {
        consolidated.birth_year = metMuseumData.birth_year;
      }
      if (!consolidated.death_year && metMuseumData.death_year) {
        consolidated.death_year = metMuseumData.death_year;
      }
      
      consolidated.art_movements.push(...(metMuseumData.art_movements || []));
      consolidated.mediums.push(...(metMuseumData.mediums || []));
      consolidated.notable_works.push(...(metMuseumData.notable_works || []));
      consolidated.total_reliability += metMuseumData.reliability || 0;
    }

    // Ï§ëÎ≥µ Ï†úÍ±∞
    consolidated.art_movements = [...new Set(consolidated.art_movements)];
    consolidated.mediums = [...new Set(consolidated.mediums)];
    consolidated.sources = [...new Set(consolidated.sources)];

    // Ïã†Î¢∞ÎèÑ Í∏∞Î∞ò confidence Î†àÎ≤® ÏÑ§Ï†ï
    if (consolidated.total_reliability >= 8) consolidated.confidence = 'high';
    else if (consolidated.total_reliability >= 5) consolidated.confidence = 'medium';

    return consolidated;
  }

  computeImportanceScore(data) {
    let score = 50; // Í∏∞Î≥∏ Ï†êÏàò

    // 1. Îç∞Ïù¥ÌÑ∞ ÏÜåÏä§ Ï†êÏàò (ÏµúÎåÄ 20Ï†ê)
    const sourceScore = Math.min(data.sources.length * 5, 20);
    score += sourceScore;

    // 2. ÏãúÎåÄÏ†Å Ï§ëÏöîÏÑ± (ÏµúÎåÄ 15Ï†ê)
    const historicalScore = this.calculateHistoricalImportance(data);
    score += historicalScore;

    // 3. ÏòàÏà† Ïö¥Îèô Ï∞∏Ïó¨ÎèÑ (ÏµúÎåÄ 15Ï†ê)
    const movementScore = Math.min(data.art_movements.length * 3, 15);
    score += movementScore;

    // 4. ÏûëÌíà Îã§ÏñëÏÑ± (ÏµúÎåÄ 10Ï†ê)
    const mediumScore = Math.min(data.mediums.length * 2.5, 10);
    score += mediumScore;

    // 5. ÎåÄÌëúÏûë Ïú†Î™ÖÎèÑ (ÏµúÎåÄ 10Ï†ê)
    const worksScore = Math.min(data.notable_works.length * 2, 10);
    score += worksScore;

    // 6. Ïã†Î¢∞ÎèÑ Î≥¥Ï†ï (ÏµúÎåÄ 10Ï†ê)
    const reliabilityScore = Math.min(data.total_reliability, 10);
    score += reliabilityScore;

    // 7. ÌäπÎ≥Ñ Í∞ÄÏÇ∞Ï†ê
    score += this.calculateBonusPoints(data);

    // ÏµúÏ¢Ö Ï†êÏàòÎäî 0-100 Î≤îÏúÑÎ°ú Ï†úÌïú
    return Math.min(Math.max(Math.round(score), 0), 100);
  }

  calculateHistoricalImportance(data) {
    if (!data.birth_year) return 5; // Í∏∞Î≥∏ Ï†êÏàò

    const birthYear = data.birth_year;
    
    // ÏãúÎåÄÎ≥Ñ Í∞ÄÏ§ëÏπò
    if (birthYear >= 1400 && birthYear <= 1600) return 15; // Î•¥ÎÑ§ÏÉÅÏä§
    if (birthYear >= 1600 && birthYear <= 1750) return 12; // Î∞îÎ°úÌÅ¨
    if (birthYear >= 1750 && birthYear <= 1850) return 10; // ÎÇ≠ÎßåÏ£ºÏùò/Ïã†Í≥†Ï†ÑÏ£ºÏùò
    if (birthYear >= 1830 && birthYear <= 1900) return 12; // Ïù∏ÏÉÅÌåå/ÌõÑÍ∏∞Ïù∏ÏÉÅÌåå
    if (birthYear >= 1880 && birthYear <= 1950) return 15; // ÌòÑÎåÄÎØ∏Ïà† Í∞úÏ≤ôÍ∏∞
    if (birthYear >= 1920 && birthYear <= 1970) return 10; // ÌòÑÎåÄÎØ∏Ïà† Î∞úÏ†ÑÍ∏∞
    if (birthYear >= 1950) return 8; // ÎèôÏãúÎåÄ ÎØ∏Ïà†

    return 5;
  }

  calculateBonusPoints(data) {
    let bonus = 0;

    // Ï£ºÏöî ÏòàÏà† Ïö¥Îèô Ï∞∏Ïó¨ Î≥¥ÎÑàÏä§
    const majorMovements = ['Renaissance', 'Impressionism', 'Cubism', 'Surrealism', 'Abstract Expressionism'];
    const participatedMajorMovements = data.art_movements.filter(movement => 
      majorMovements.some(major => movement.includes(major))
    );
    bonus += participatedMajorMovements.length * 2;

    // Îã§Íµ≠Ï†Å Ïù∏ÏßÄÎèÑ Î≥¥ÎÑàÏä§ (Ïó¨Îü¨ ÏÜåÏä§ÏóêÏÑú ÌôïÏù∏Îêú Í≤ΩÏö∞)
    if (data.sources.length >= 3) bonus += 3;

    // ÌïúÍµ≠ ÏûëÍ∞Ä ÌäπÎ≥Ñ Í∞ÄÏÇ∞Ï†ê (Î¨∏ÌôîÏ†Å Îã§ÏñëÏÑ± Ï¶ùÏßÑ)
    if (data.nationality && data.nationality.toLowerCase().includes('korean')) {
      bonus += 5;
    }

    return Math.min(bonus, 15); // ÏµúÎåÄ 15Ï†ê Î≥¥ÎÑàÏä§
  }

  calculateDataCompleteness(data) {
    const fields = ['nationality', 'birth_year', 'death_year', 'art_movements', 'bio'];
    const completedFields = fields.filter(field => {
      const value = data[field];
      return value && (Array.isArray(value) ? value.length > 0 : true);
    });
    
    return Math.round((completedFields.length / fields.length) * 100);
  }

  analyzePersonalityIndicators(data) {
    const indicators = {
      leadership_tendency: 0,    // L vs S
      action_orientation: 0,     // A vs R  
      emotional_expression: 0,   // E vs M
      flexibility: 0,            // F vs C
      confidence: 'medium'
    };

    // BioÏôÄ ÌäπÏßïÏóêÏÑú ÏÑ±Í≤© ÏßÄÌëú Ï∂îÏ∂ú
    const text = (data.bio + ' ' + data.characteristics.join(' ')).toLowerCase();

    // Leadership vs Support ÏßÄÌëú
    const leadershipKeywords = ['pioneer', 'revolutionary', 'founded', 'established', 'innovative', 'influential'];
    const supportKeywords = ['traditional', 'follower', 'influenced by', 'student of', 'collaborative'];
    
    indicators.leadership_tendency = this.calculateKeywordScore(text, leadershipKeywords, supportKeywords);

    // Action vs Reflection ÏßÄÌëú  
    const actionKeywords = ['experimental', 'bold', 'dramatic', 'energetic', 'spontaneous'];
    const reflectionKeywords = ['contemplative', 'meditative', 'quiet', 'philosophical', 'thoughtful'];
    
    indicators.action_orientation = this.calculateKeywordScore(text, actionKeywords, reflectionKeywords);

    // Emotional vs Mental ÏßÄÌëú
    const emotionalKeywords = ['emotional', 'passionate', 'expressive', 'feeling', 'intuitive'];
    const mentalKeywords = ['analytical', 'intellectual', 'rational', 'systematic', 'logical'];
    
    indicators.emotional_expression = this.calculateKeywordScore(text, emotionalKeywords, mentalKeywords);

    // Flexible vs Consistent ÏßÄÌëú
    const flexibleKeywords = ['versatile', 'changing', 'experimental', 'varied', 'diverse'];
    const consistentKeywords = ['consistent', 'systematic', 'methodical', 'disciplined', 'structured'];
    
    indicators.flexibility = this.calculateKeywordScore(text, flexibleKeywords, consistentKeywords);

    // Ïã†Î¢∞ÎèÑ ÏÑ§Ï†ï
    const totalKeywords = leadershipKeywords.length + supportKeywords.length + actionKeywords.length + 
                         reflectionKeywords.length + emotionalKeywords.length + mentalKeywords.length +
                         flexibleKeywords.length + consistentKeywords.length;
    
    const foundKeywords = this.countFoundKeywords(text, [
      ...leadershipKeywords, ...supportKeywords, ...actionKeywords, ...reflectionKeywords,
      ...emotionalKeywords, ...mentalKeywords, ...flexibleKeywords, ...consistentKeywords
    ]);

    if (foundKeywords >= 5) indicators.confidence = 'high';
    else if (foundKeywords >= 3) indicators.confidence = 'medium';
    else indicators.confidence = 'low';

    return indicators;
  }

  calculateKeywordScore(text, positiveKeywords, negativeKeywords) {
    const positiveCount = positiveKeywords.filter(keyword => text.includes(keyword)).length;
    const negativeCount = negativeKeywords.filter(keyword => text.includes(keyword)).length;
    
    if (positiveCount + negativeCount === 0) return 0;
    
    // -1 (ÏôÑÏ†Ñ negative) ~ +1 (ÏôÑÏ†Ñ positive) Î≤îÏúÑÎ°ú Ï†ïÍ∑úÌôî
    return (positiveCount - negativeCount) / (positiveCount + negativeCount);
  }

  countFoundKeywords(text, keywords) {
    return keywords.filter(keyword => text.includes(keyword)).length;
  }
}

module.exports = DataBasedImportanceCalculator;